{
  "actions": [
    {
      "id": "widget-attach-button",
      "name": "Add add widget button to all editable sections",
      "dependencies": ["widget-fetch-add-button", "widget-iterate-section"],
      "sequence": [
        {
          "dsAction": "get/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "id": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsSectionId"]
              }
            },
            "options": {
              "clone": true
            }
          }
        },
        {
          "dsAction": "condition",
          "dsArgs": {
            "if": [{
              "op": "==",
              "from": {
                "dsAction": "get/blockValue",
                "dsArgs": {
                  "value": {
                    "dsAction": "get/sequenceValue",
                    "dsArgs": {
                      "$key": [0]
                    }
                  },
                  "map": {
                    "$key": ["length"]
                  }
                }
              },
              "to": 0
            }],
            "then": [2],
            "else": [3, 4, 5]
          }
        },
        {
          "dsAction": "dsAction/dispatch",
          "async": true,
          "dsArgs": {
            "id": "widget-fetch-add-button",
            "context": {
              "dsAction": "get/contextValue"
            }
          }
        },
        {
          "async": true,
          "dsAction": "dsList/iterate",
          "dsArgs": {
            "async": true,
            "items": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": [0]
              }
            },
            "context": {
              "dsSectionId": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsSectionId"]
                }
              },
              "dsViewId": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsViewId"]
                }
              },
              "dsWidgets": {
                "dsAction": "get/sequenceValue",
                "dsArgs": {
                  "$key": [0]
                }
              }
            },
            "dsActionId": "widget-iterate-section"
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": [0]
              }
            },
            "options": {
              "stopPropagation": true,
              "id": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsSectionId"]
                }
              }
            }
          }
        },
        {
          "dsAction": "dsSection/render",
          "dsArgs": {
            "id": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsSectionId"]
              }
            },
            "dsViewId": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsViewId"]
              }
            }
          }
        }
      ]
    },
    {
      "id": "widget-iterate-section",
      "sequence": [
        {
          "dsAction": "get/dataValue",
          "dsArgs": {
            "name": "dsWidget/templates",
            "id": {
              "dsAction": "get/payloadValue",
              "dsArgs": {
                "$key": "value"
              }
            }
          }
        },
        {
          "dsAction": "condition",
          "dsArgs": {
            "if": [
              {
                "op": "!=",
                "from": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [0]
                  }
                },
                "to": "bootstrap-widget-add-button"
              },
              {
                "andOr": "&&"
              },
              {
                "op": "!=",
                "from": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [0]
                  }
                },
                "to": "bootstrap-widget-add"
              }
            ],
            "then": [2, 3, 4],
            "else": []
          }
        },
        {
          "dsAction": "dsOperator/eval",
          "dsArgs": {
            "name": "++",
            "values": [
              {
                "dsAction": "get/payloadValue",
                "dsArgs": {
                  "$key": ["key"]
                }
              }
            ]
          }
        },
        {
          "dsAction": "get/dataValue",
          "dsArgs": {
            "name": "dsWidget/templates",
            "id": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsWidgets", {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key" : [2]
                  }
                }]
              }
            }
          }
        },
        {
          "dsAction": "condition",
          "dsArgs": {
            "if": [
              {
                "op": "!=",
                "from": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [3]
                  }
                },
                "to": "bootstrap-widget-add-button"
              },
              {
                "andOr": "&&"
              },
              {
                "op": "!=",
                "from": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [3]
                  }
                },
                "to": "bootstrap-widget-add"
              }
            ],
            "then": [5, 6],
            "else": []
          }
        },
        {
          "async": true,
          "dsAction": "dsTemplate/create",
          "dsArgs": {
            "id": "bootstrap-widget-add-button"
          }
        },
        {
          "dsAction": "dsList/splice",
          "dsArgs": {
            "target": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsWidgets"]
              }
            },
            "start": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key" : [2]
              }
            },
            "source": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key" : [5]
              }
            }
          }
        }
      ]
    },
    {
      "id": "widget-fetch-add-button",
      "name": "Append add new button",
      "sequence": [
        {
          "async": true,
          "dsAction": "dsTemplate/create",
          "dsArgs": {
            "id": "bootstrap-widget-add-button"
          }
        },
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": "bootstrap-widget-add__widget-id",
                "value": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [0]
                  }
                }
              }
            ]
          }
        },
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": "bootstrap-widget-add__section-id",
                "value": {
                  "dsAction": "get/contextValue",
                  "dsArgs": {
                    "$key": ["dsSectionId"]
                  }
                }
              }
            ]
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": [0]
              }
            },
            "options": {
              "stopPropagation": true,
              "id": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsSectionId"]
                }
              },
              "update": {
                "method": "push"
              }
            }
          }
        },
        {
          "dsAction": "dsSection/render",
          "dsArgs": {
            "id": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsSectionId"]
              }
            },
            "dsViewId": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsViewId"]
              }
            }
          }
        }
      ]
    },
    {
      "id": "widget-add",
      "name": "Add new widget",
      "sequence": [
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": "bootstrap-widget-add__section-id",
                "value": {
                  "dsAction": "get/contextValue",
                  "dsArgs": {
                    "$key": ["dsSectionId"]
                  }
                }
              }
            ]
          }
        },
        {
          "dsAction": "condition",
          "dsArgs": {
            "if": [
              {
                "op": "==",
                "from": {
                  "dsAction": "get/blockValue",
                  "dsArgs": {
                    "value": {
                      "dsAction": "get/dataValue",
                      "dsArgs": {
                        "name": "dsContent/items",
                        "id": "widget-add-button"
                      }
                    },
                    "map": {
                      "$key": ["values", "checked"]
                    }
                  }
                },
                "to": true       
              }
            ],
            "then": [2, 3, 4],
            "else": [5]
          }
        },
        {
          "async": true,
          "dsAction": "dsTemplate/create",
          "dsArgs": {
            "id": "bootstrap-widget-add",
            "widgetOptions": {
              "groupId": {
                "dsAction": "get/dataValue",
                "dsArgs": {
                  "name": "dsWidget/items",
                  "id": "widget:id"
                }
              }
            },
            "actionGroupId": {
              "dsAction": "get/dataValue",
              "dsArgs": {
                "name": "dsWidget/actionGroups",
                "id": "widget:id"
              }
            }
          }
        },
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": "bootstrap-widget-add-close__widget-id",
                "value": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": [2]
                  }
                }
              },
              {
                "id": "bootstrap-widget-add__content-id",
                "value": "widget-add-button"
              }
            ]
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": [2]
              }
            },
            "options": {
              "id": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsSectionId"]
                }
              },
              "update": {
                "method": "splice",
                "startIndex": {
                  "dsAction": "dsOperator/eval",
                  "dsArgs": {
                    "name": "++",
                    "values": [{
                      "dsAction": "dsWidget/attachedToIndex",
                      "dsArgs": {
                        "id": "widget:id"
                      }
                    }]
                  }
                }
              }
            }
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/actionValue",
              "dsArgs": {
                "$key": ["bootstrap-widget-add-close__widget-id"]
              }
            },
            "options": {
              "id": {
                "dsAction": "get/contextValue",
                "dsArgs": {
                  "$key": ["dsSectionId"]
                }
              },
              "update": {
                "method": "pull"
              }
            }
          }
        }
      ]
    },
    {
      "id": "widget-add-close",
      "name": "Close add widget",
      "groupId": "widget-fetch-add-button",
      "sequence": [
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": "widget:id",
            "options": {
              "id": {
                "dsAction": "get/dataValue",
                "dsArgs": {
                  "name": "dsWidget/attached",
                  "id": "widget:id"
                }
              },
              "update": {
                "method": "pull"
              }
            }
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsContent/items",
            "value": false,
            "options": {
              "id": {
                "dsAction": "dsOperator/eval",
                "dsArgs": {
                  "name": "+",
                  "values": [
                    {
                      "dsAction": "get/actionValue",
                      "dsArgs": {
                        "$key": ["bootstrap-widget-add__content-id"]
                      }
                    },
                    {
                      "dsAction": "get/dataValue",
                      "dsArgs": {
                        "name": "dsMetadata/language"
                      }
                    }
                  ]
                }
              },
              "update": {
                "position": ["values", "checked"]
              }
            }
          }
        }
      ]
    },
    {
      "id": "widget-display-add-item",
      "name": "Add widget item",
      "sequence": [
        {
          "async": true,
          "dsAction": "dsTemplate/create",
          "dsArgs": {
            "id": "bootstrap-widget-add-item",
            "contentOptions": {
              "icon": {
                "values": {
                  "value": {
                    "dsAction": "get/payloadValue",
                    "dsArgs": {
                      "$key": "value.item.icon"
                    }
                  }
                }
              },
              "title": {
                "tokens": {
                  "value": false
                },
                "values": {
                  "value": {
                    "dsAction": "get/payloadValue",
                    "dsArgs": {
                      "$key": "value.item.name"
                    }
                  }
                }
              },
              "text": {
                "tokens": {
                  "value": false
                },
                "values": {
                  "value": {
                    "dsAction": "get/payloadValue",
                    "dsArgs": {
                      "$key": "value.item.description"
                    }
                  }
                }
              }
            },
            "actionGroupId": {
              "dsAction": "get/dataValue",
              "dsArgs": {
                "name": "dsWidget/actionGroups",
                "id": "widget:id"
              }
            },
            "widgetOptions": {
              "groupId": {
                "dsAction": "get/dataValue",
                "dsArgs": {
                  "name": "dsWidget/items",
                  "id": {
                    "dsAction": "get/contextValue",
                    "dsArgs": {
                      "$key": ["dsWidgetId"]
                    }
                  }
                }
              }
            }
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": [0]
              }
            },
            "options": {
              "id": {
                "dsAction": "get/dataValue",
                "dsArgs": {
                  "name": "dsWidget/sections",
                  "id": "widget-add-list",
                  "options": {
                    "position": "widget-add-list:index"
                  }
                }
              },
              "update": {
                "method": "push"
              }
            }
          }
        },
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": {
                 "dsAction": "dsOperator/eval",
                  "dsArgs": {
                    "name": "+",
                    "values": [
                      {
                        "dsAction": "get/sequenceValue",
                        "dsArgs": {
                          "$key": ["0"]
                        }
                      },
                      "bootstrap-widget-template-id"
                    ]
                  }
                },
                "value": {
                  "dsAction": "get/payloadValue",
                  "dsArgs": {
                    "$key": "value.id"
                  }
                }
              },
              {
                "id": "bootstrap-widget-add-list__section-id",
                "value": {
                  "dsAction": "get/dataValue",
                  "dsArgs": {
                    "name": "dsWidget/sections",
                    "id": "widget-add-list",
                    "options": {
                      "position": "widget-add-list:index"
                    }
                  }
                }
              }
            ]
          }
        }
      ]
    },
    {
      "id": "widget-add-fetch",
      "name": "Fetch widgets",
      "dependencies": ["widget-display-add-item"],
      "sequence": [
        {
          "async": true,
          "dsAction": "dsDatabase/getAll",
          "dsArgs": {
            "collection": "template/metadata"
          }
        },
        {
          "dsAction": "dsList/iterate",
          "dsArgs": {
            "context": {
              "dsAction": "get/contextValue"
            },
            "items": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": ["0"]
              }
            },
            "dsActionId": "widget-display-add-item"
          }
        }
      ]
    },
    {
      "id": "widget-add-item",
      "name": "Add widget",
      "sequence": [
        {
          "async": true,
          "dsAction": "dsTemplate/create",
          "dsArgs": {
            "id": {
              "dsAction": "get/actionValue",
              "dsArgs": {
                "$key": [{
                  "dsAction": "dsOperator/eval",
                   "dsArgs": {
                     "name": "+",
                     "values": [
                       {
                         "dsAction": "get/contextValue",
                         "dsArgs": {
                           "$key": ["dsWidgetId"]
                         }
                       },
                       "bootstrap-widget-template-id"
                     ]
                   }
                 }]
              }
            },
            "widgetOptions": {
              "groupId": {
                "dsAction": "get/dataValue",
                "dsArgs": {
                  "name": "dsWidget/items",
                  "id": {
                    "dsAction": "get/contextValue",
                    "dsArgs": {
                      "$key": ["dsWidgetId"]
                    }
                  }
                }
              }
            },
            "actionGroupId": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsWidgetId"]
              }
            }
          }
        },
        {
          "dsAction": "set/dataValue",
          "dsArgs": {
            "name": "dsSection/items",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": ["0"]
              }
            },
            "options": {
              "id": {
                "dsAction": "get/actionValue",
                "dsArgs": {
                  "$key": ["bootstrap-widget-add__section-id"]
                }
              },
              "update": {
                "method": "push"
              }
            }
          }
        }
      ]
    },
    {
      "id": "attribute-id-uuid",
      "name": "Create unique id and set",
      "sequence": [
        {
          "dsAction": "dsData/generateId"
        },
        {
          "dsAction": "dsView/setAttribute",
          "dsArgs": {
            "dsViewId": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsViewId"]
              }
            },
            "name": "id",
            "value": {
              "dsAction": "get/sequenceValue",
              "dsArgs": {
                "$key": ["0"]
              }
            }
          }
        },
        {
          "dsAction": "set/actionValue",
          "dsArgs": {
            "values": [
              {
                "id": "uuid",
                "value": {
                  "dsAction": "get/sequenceValue",
                  "dsArgs": {
                    "$key": ["0"]
                  }
                }
              }
            ]
          }
        }
      ]
    },
    {
      "id": "attribute-for-uuid",
      "name": "Get uuid from sequence value",
      "sequence": [
        {
          "dsAction": "dsView/setAttribute",
          "dsArgs": {
            "dsViewId": {
              "dsAction": "get/contextValue",
              "dsArgs": {
                "$key": ["dsViewId"]
              }
            },
            "name": "for",
            "value": {
              "dsAction": "get/actionValue",
              "dsArgs": {
                "$key": ["uuid"]
              }
            }
          }
        }
      ]
    }
  ]
}